\chapter{Network}
\label{chapter:network}

TODO: haltsoon and rebootsoon

\begin{figure*}
\begin{center}
\resizebox{!}{0.9\textheight}{
\begin{tikzpicture}
[
 thick,
 box/.style={
  draw,
  minimum height=1cm,
  minimum width=2cm,
  inner sep=1mm,
  align=center,
 }
]
 \footnotesize
 \node at (0,0) (internet) [box] {Internet};
 
 \draw[dashed] (-4.5,1.0) -- (+7.5,1.0) -- (+7.5,6.0) -- (-4.5,6.0) -- node [above,rotate=90] {84-cm} cycle;

 \node at (0,2.0) (oan-firewall) [box] {OAN/SPM\\Firewall};
 \ifcoatlioan
 \node at (3,3.5) (webcam-c) [box] {webcam-c\\132.148.4.16};
 \fi
 \ifddotioan
 \node at (3,3.5) (webcam-c) [box] {webcam-c\\132.148.4.26};
 \fi
 \node at (0,3.5) (switch-84) [box] {Switch\\84-cm};
 \node at (0,5.0) (fiber-84) [box] {Fibre Adapter};
 
 \draw (internet) -- (oan-firewall);
 \draw (switch-84) -- (webcam-c);
 \draw (oan-firewall) -- (switch-84);
 \draw (switch-84) -- (fiber-84);

 \draw[dashed] (-4.5,6.5) -- (+7.5,6.5) -- (+7.5,13.0) -- (-4.5,13.0) -- node [above,rotate=90] {Shed} cycle;
 
 \node at (0,7.5) (fiber-shed) [box] {Fibre Adapter};
 \node at (0,9.0) (firewall) [box] {10.0.1.1\\firewall\\{\projectexternalipaddress}};
 \node at (0,10.5) (switch-rack) [box] {Switch\\Rack};

 \draw (fiber-84) -- (fiber-shed);
 \draw (fiber-shed) -- (firewall);
 \draw (firewall) -- (switch-rack);

 \node at (-3,12.0) (access) [box] {access\\10.0.1.2};
 \node at (-3,10.5) (services) [box] {services\\10.0.1.3};
 \node at (-3,9.0) (control) [box] {control\\10.0.1.9};
 \node at (+3,12.0) (ibb-220) [box] {ibb-220\\10.0.1.4}; 
 \node at (+3,9.0) (ibb-127) [box] {ibb-127\\10.0.1.5}; 
 \node at (+6,11.25) (mount) [box] {mount\\10.0.1.6};
 \node at (+6,9.75) (serial) [box] {serial\\10.0.1.7};
 
 \draw (switch-rack) -- (access);
 \draw (switch-rack) -- (services);
 \draw (switch-rack) -- (control);
 \draw (switch-rack) -- (ibb-127);
 \draw (switch-rack) -- (ibb-220);
 \draw (switch-rack) -- (mount);
 \draw (switch-rack) -- (serial);
 
 \draw[dashed] (-4.5,13.5) -- (+7.5,13.5) -- (+7.5,17.0) -- (-4.5,17.0) -- node [above,rotate=90] {Platform} cycle;

 \node at (0,15.25) (switch-c) [box] {Switch\\Box C};
 \node at (-3,14.5) (c0) [box] {c0\\10.0.1.11}; 
 \node at (-3,16.0) (airport-express) [box] {airport-express\\10.0.1.10}; 
 \draw (switch-c) -- (c0);
 \node at (+3,14.5) (webcam-a) [box] {webcam-a\\10.0.1.20}; 
 \node at (+3,16.0) (webcam-b) [box] {webcam-b\\10.0.1.21}; 
 \draw (switch-rack) -- (switch-c);
 \draw (switch-c) -- (webcam-a);
 \draw (switch-c) -- (webcam-b);
 \draw (switch-c) -- (airport-express);
 \ifcoatlioan
 \node at (+6,15.25) (d0) [box] {d0\\10.0.1.12}; 
 \draw (switch-c) -- (d0);
 \fi
 
 \ifcoatlioan 
 \draw[dashed] (-4.5,17.5) -- (+7.5,17.5) -- (+7.5,19.5) -- (-4.5,19.5) -- node [above,rotate=90] {Telescope} cycle;
 \node at (0,18.5) (switch-e) [box] {Switch\\Box E};
 \node at (-3,18.5) (e0) [box] {e0\\10.0.1.15}; 
 \node at (+3,18.5) (e1) [box] {e1\\10.0.1.16}; 
 \draw (switch-c) -- (switch-e);
 \draw (switch-e) -- (e0);
 \draw (switch-e) -- (e1);
 \fi

 \ifddotioan 
 \draw[dashed] (-4.5,17.5) -- (+7.5,17.5) -- (+7.5,25.5) -- (-4.5,25.5) -- node [above,rotate=90] {Telescope} cycle;
 \node at (-3,20.5) (d0) [box] {d0\\10.0.1.12}; 
 \node at (-3,18.5) (d1) [box] {d1\\10.0.1.13}; 
 \node at (+3,20.5) (d2) [box] {d2\\10.0.1.14}; 
 \node at (+3,18.5) (d3) [box] {d3\\10.0.1.15}; 
 \node at (0,19.75) (switch-d) [box] {Switch\\Box D};
 \draw (switch-c) -- (switch-d);
 \draw (switch-d) -- (d0);
 \draw (switch-d) -- (d1);
 \draw (switch-d) -- (d2);
 \draw (switch-d) -- (d3);
 \node at (-3,24.5) (e0) [box] {e0\\10.0.1.16}; 
 \node at (-3,22.5) (e1) [box] {e1\\10.0.1.17}; 
 \node at (+3,24.5) (e2) [box] {e2\\10.0.1.18}; 
 \node at (+3,22.5) (e3) [box] {e3\\10.0.1.19}; 
 \node at (0,23.75) (switch-e) [box] {Switch\\Box E};
 \draw (switch-d) -- (switch-e);
 \draw (switch-e) -- (e0);
 \draw (switch-e) -- (e1);
 \draw (switch-e) -- (e2);
 \draw (switch-e) -- (e3);
 \fi
 
\end{tikzpicture}
}
\end{center}
\caption{Network Physical Topology}
\label{figure:network-topology}
\end{figure*}

\section{WAN and LAN Addresses}

The observatory uses 132.248.4/24 as a WAN. {\projectname} uses 10.0.1/24 as a LAN. The firewall computer in the rack in the shed serves as a firewall and router between the WAN and the LAN. The addresses of the equipment are given in Table~\ref{table:network-addresses}.

\begin{table}
\caption{Addresses}
\label{table:network-addresses}
\begin{center}
\footnotesize
\begin{tabular}{llll}
\hline
Address&Name&Equipment&Location\\
\hline
{\projectexternalipaddress}&\verb|firewall|&HP Server&Rack\\
10.0.1.1&\verb|firewall|&HP Server&Rack\\
10.0.1.2&\verb|access|&Mac mini&Rack\\
10.0.1.3&\verb|services|&HP Server&Rack\\
10.0.1.4&\verb|ibb-220|&iBootBar 220 V&Rack\\
10.0.1.5&\verb|ibb-127|&iBootBar 127 V&Rack\\
10.0.1.6&\verb|mount|&Mount Controller&Rack\\
10.0.1.7&\verb|serial|&HP Adapter&Shed Wall\\
10.0.1.8&\verb|pc|&PC&Not currently installed\\
10.0.1.9&\verb|control|&Linux Server&Rack\\
10.0.1.10&\verb|airport-express|&Airport Express&Box C\\
\ifcoatlioan
10.0.1.11&\verb|c0|&Minnowboard Max&Box C\\
10.0.1.12&\verb|d0|&Minnowboard Max&Box D\\
10.0.1.15&\verb|e0|&Minnowboard Max&Box E\\
10.0.1.16&\verb|e1|&Minnowboard Max&Box E\\
\fi
\ifddotioan
10.0.1.11&\verb|c0|&Minnowboard Turbot&Box C\\
10.0.1.12&\verb|d0|&Minnowboard Turbot&Box D\\
10.0.1.13&\verb|d1|&Minnowboard Turbot&Box D\\
10.0.1.14&\verb|d2|&Minnowboard Turbot&Box D\\
10.0.1.15&\verb|d3|&Minnowboard Turbot&Box D\\
10.0.1.16&\verb|e0|&Minnowboard Turbot&Box E\\
10.0.1.17&\verb|e1|&Minnowboard Turbot&Box E\\
10.0.1.18&\verb|e2|&Minnowboard Turbot&Box E\\
10.0.1.19&\verb|e3|&Minnowboard Turbot&Box E\\
\fi
10.0.1.20&\verb|webcam-a|&Webcam&Platform (above Box B)\\
10.0.1.21&\verb|webcam-b|&Webcam&Platform (above Box C)\\
\hline
\ifcoatlioan
132.248.4.16&\verb|webcam-c|&Webcam&84-cm (SE side)\\
\fi
\ifddotioan
132.248.4.26&\verb|webcam-c|&Webcam&84-cm (NE side)\\
\fi
\hline
\end{tabular}
\end{center}
\end{table}

\section{Port Filtering and Forwarding}

The observatory firewall filters access to {\ttfamily \projectexternalipname} ({\projectexternalipaddress}) from outside the observatory WAN except for ports TCP/22 (SSH), TCP/80 (HTTP), and \ifcoatlioan
TCP/5349 (GCN/TAN).
\fi
\ifddotioan
TCP/5351 (GCN/TAN).
\fi

The firewall forwards certain TCP ports from its WAN address to hosts on the LAN. These are listed in Table~\ref{table:port-forwarding}. The firewall restricts access on most of these port, with only the main ssh port being open to all hosts.

\begin{table}
\caption{Ports Forwarded from the WAN to the LAN}
\label{table:port-forwarding}
\begin{center}
\begin{tabular}{llll}
\hline
Port on WAN&Host on LAN&Port on LAN&Notes\\
\hline
22&\verb|access|&22&Main ssh access.\\
80&\verb|services|&80&Web page and interface.\\
873&\verb|services|&5349&rsync.\\
2222&\verb|firewall|&22&Backup ssh access.\\
\ifcoatlioan
5349&\verb|services|&5349&GCN/TAN notices.\\
\fi
\ifddotioan
5351&\verb|services|&5351&GCN/TAN notices.\\
\fi
\hline
\end{tabular}
\end{center}
\end{table}

\section{Access}

All of the hosts have an account {\projectaccount} with password {\projectaccount}. Local and ssh access is permitted on the Linux machines, but only local access is permitted on the \verb|access|.

SSH access to \verb|access| is limited to the accounts of project staff and the OAN/SPM network maintenance staff. Thus, remote access is accomplished by first logging into \verb|access| using a non-{\projectaccount} account and then logging into a local machine using the {\projectaccount} account.

We recommend using an \href{https://help.ubuntu.com/community/SSH/OpenSSH/Keys}{SSH public key} to avoid needing to type passwords repeatedly. If you do not have a key, you can generate one by running these commands on your computer:
\begin{verbatim}
mkdir ~/.ssh
chmod 700 ~/.ssh
ssh-keygen -t rsa
\end{verbatim}
Once you have generated a key, you can copy it to \verb|access| using:
\ifcoatlioan
\begin{verbatim}
ssh-copy-id user@coatli.astrossp.unam.mx
\end{verbatim}
\fi
\ifddotioan
\begin{verbatim}
ssh-copy-id user@ddoti.astrossp.unam.mx
\end{verbatim}
\fi
You should then by able to ssh to \verb|access| without having to type your password.

Having copied the key to access, you can copy it to the {\projectaccount} accounts on the other computers on the LAN by running this command on \verb|access|:
\begin{verbatim}
ssh-copy-id-to-lan
\end{verbatim}
To use your key this, you should make sure that the key is forwarded by using the \verb|-A| option to ssh when you connect to \verb|access| or by adding the \verb|ForwardAgent yes| option to your \verb|.ssh/config| file.

\section{Wireless Networks}

There are two wireless networks for general use. 
\ifcoatlioan
The access Mac in the shed implements \verb|apcoatli0| and the Airport Extreme in Box C on the platform implements \verb|apcoatli1|. 
\fi
\ifddotioan
The access Mac in the shed implements \verb|apddoti0| and the Airport Extreme in Box C on the platform implements \verb|apddoti1|. 
\fi
The password is “keplerxv”.

\section{DHCP}

The firewall runs a DHCP server that allocates addresses in the range 10.0.1.100 to 10.0.1.200.

