\chapter{Archive}

\section{Introduction}

The control system generates many data files during operations. 

Most of the data files are organized by first date and then component. For example, all files for the UTC date YYYYMMDD generated by the sensors component are located in
\begin{quote}
\verb|/usr/local/var/tcs/YYYYMMDD/sensors/|
\end{quote}

Some components have subdirectories at the top level for data files that are applicable to more than one night. For example, the selector maintains the alert files in
\begin{quote}
\verb|/usr/local/var/tcs/selector/alerts/|
\end{quote}


These files are copied from the control system computers at the telescope to the archive. This is a central NAS on the private transients subnetwork at the OAN. Public access is via SSH, RSYNC, HTTP access to \verb|transients.astrossp.unam.mx|. The NAS is shared by the control system computers and the data pipelines for RATIR, COATLI, DDOTI.

The archive volume on the NAS is mounted on other computers on the transients network at:

\begin{quote}
\ifcoatli
\verb|/nas/archive-coatli|/
\fi
\ifddoti
\verb|/nas/archive-ddoti/|
\fi
\end{quote}

The data files on the control system computers are copied by rsync to the subdirectory \verb|raw| in the archive volume. The log files are copied every minute, the FITS data and header files every five minutes, and the other files every hour.

\section{Logs}

The log files are created under

\begin{quote}
\verb|/usr/local/var/tcs/YYYYMMDD/log/|
\end{quote}

They are mainly of interest to the engineering and operations team.

\section{Image Files}

The image files are created under

\begin{quote}
\verb|/usr/local/var/tcs/YYYYMMDD/executor/images/|
\end{quote}

The files are created below this directory in subdirectories whose names are the program, block, and visit identifiers. For example, the files for program 2022A-2001, block 10, visit 0 are created in

\begin{quote}
\verb|/usr/local/var/tcs/YYYYMMDD/executor/images/2022A-2001/10/0/|
\end{quote}

The base name of each image created by the executor is the UTC time in ISO 8601 basic combined format followed by the channel name (e.g., \verb|C0|, \verb|C1|, \verb|C2|, \ldots), followed by a letter indicating the type of exposure (\verb|o| for object, \verb|f| for flat, \verb|b| for bias, and \verb|d| for dark). 
\ifcoatli
If the image is a data cube, a further letter \verb|c| follows. In this case, both a normal image and a data cube may be present with identical names except for the letter \verb|c|. The normal image typically representing a quickly flattened version of the data cube.
\fi
For example,

\begin{quote}
\verb|20220405T072311C0o|\\
\ifcoatli
\verb|20220405T072311C0oc|\\
\fi
\verb|20220405T072341C0b|\\
\verb|20220405T072351C0f|\\
\verb|20220405T072411C0d|
\end{quote}

\ifcoatli
For each image there are two files (or four for cubes): 
\fi
\ifddoti
For each image there are two files: 
\fi
the full FITS image compressed losslessly with fpack (with suffix \verb|.fz|) and a text version of the header (with suffix \verb|.fits.txt|). In the text version, each record is separated with a newline character.

\section{FITS Header Records}

The FITS header records are largely self-documented by comments. However, these are the most relevant header records for searching for particular data:

\begin{itemize}
\item \verb|DATE-OBS|: The UTC date of the start of the exposure.
\item \verb|CCD_NAME|: The channel (e.g., \verb|C0|, \verb|C1|, \verb|C2|, \ldots).
\item \verb|EXPTIME|: The exposure time (seconds).
\item \verb|EXPTYPE|: The exposure type (e.g., \verb|object|, \verb|flat|, \verb|bias|, \verb|dark|).
\item \verb|FILTER|: The selected filter name.
\item \verb|BINNING|: The detected binning (pixels).
\item \verb|READMODE|: The detector read mode.
\item \verb|PRPID|: The proposal identifier (integer).
\item \verb|BLKID|: The block identifier (integer).
\item \verb|VSTID|: The visit identifier (integer).
\item \verb|STRSTRA|: The J2000 RA of the target at the start of the exposure (degrees).
\item \verb|STRSTDE|: The J2000 declination of the target at the start of the exposure (degrees).
\item \verb|STROBHA|: The observed HA of the target at the start of the exposure (degrees).
\item \verb|STROBDE|: The observed declination of the target at the start of the exposure (degrees).
\item \verb|STROBAZ|: The observed azimuth of the target at the start of the exposure (degrees).
\item \verb|STROBZ|: The observed zenith distance of the target at the start of the exposure (degrees).
\item \verb|STROAM|: The observed airmass of the target at the start of the exposure.
\item \verb|SMNZD|: The observed zenith distance of the Moon at the start of the exposure (degrees).
\item \verb|SMNIL|: The illuminated fraction of the Moon at the start of the exposure.
\item \verb|SMNTD|: The distance between the target and the Moon at the start of the exposure (degrees).
\item \verb|SSNZD|: The observed zenith distance of the Sun at the start of the exposure (degrees).
\end{itemize}
For all of the records that begin with \verb|S| and refer to the start of the exposure, there is another record that begins with \verb|E| and refers to the end of the exposure. So, for example, \verb|STROAM| gives the airmass at the start of the exposure and \verb|ETROAM| gives the airmass at the end of the exposure.

